## Ghid: Crearea unei Aplicații folosind GCP (Google Cloud Provider)

În acest ghid, vom învăța cum să creăm o aplicație simplă Node.js care accesează un API extern pentru a genera numere aleatorii. Vom utiliza API-ul Random.org pentru acest exemplu.

### Pasul 1: Crearea Proiectului și Configurarea Setărilor Folosind Cloud Shell

1. Deschide [Google Cloud Console](https://console.cloud.google.com/) într-un browser web.

2. În partea de sus dreapta a ecranului, apasă pe butonul "Activate Cloud Shell" pentru a deschide Cloud Shell.

3. În Cloud Shell, asigură-te că ești autentificat cu contul tău Google și că folosești proiectul corect. Poți verifica proiectul actual folosind comanda:

```bash
gcloud config list project
```

Dacă proiectul afișat nu este "AplicatieManagementStudenti" sau proiectul dorit, folosește comanda gcloud config set project pentru a seta proiectul corect:

```bash
gcloud config set project aplicatie-management-studenti
```
Înlocuiește "numele-proiectului" cu numele proiectului pe care îl dorești.

4. Dacă proiectul "AplicatieManagementStudenti" nu există, poți crea unul nou folosind comanda:

```bash
gcloud projects create aplicatie-management-studenti --name="Aplicatie Management Studenti"
```

Această comandă va crea un proiect nou cu numele "AplicatieManagementStudenti". Poți înlocui numele și descrierea proiectului cu ceea ce dorești.

5. După ce proiectul este creat sau selectat, asigură-te că ești în proiectul corect înainte de a continua.
Verifică și activează "Billing Account".

6. Creează un nou service account cu numele "management-studenti-svc" folosind comanda:

```bash
gcloud iam service-accounts create management-studenti-svc --display-name "Service Account pentru Managementul Studenților"
```

7. După ce service account-ul este creat, asignează drepturile "Cloud Run Invoker" și "Storage Admin" folosind comanda. Asigură-te că înlocuiești "numele-proiectului" cu numele proiectului tău.

```bash
gcloud projects add-iam-policy-binding numele-proiectului \
--member=serviceAccount:management-studenti-svc@numele-proiectului.iam.gserviceaccount.com \
--role=roles/run.invoker

gcloud projects add-iam-policy-binding numele-proiectului \
--member=serviceAccount:management-studenti-svc@numele-proiectului.iam.gserviceaccount.com \
--role=roles/storage.admin

gcloud projects add-iam-policy-binding numele-proiectului \
--member=serviceAccount:management-studenti-svc@numele-proiectului.iam.gserviceaccount.com \
--role=roles/aiplatform.admin

gcloud projects add-iam-policy-binding numele-proiectului \
--member=serviceAccount:management-studenti-svc@numele-proiectului.iam.gserviceaccount.com \
--role=roles/datastore.owner
```

8. După ce proiectul este selectat sau creat, poți crea primul bucket, "date-media-utilizator-neprocesate", folosind următoarea comandă:

```bash
gsutil mb -l europe-west1 gs://date-media-utilizator-neprocesate
```
9. Repetă comanda de mai sus pentru a crea și al doilea bucket, "date-media-utilizator-procesate".

```bash
gsutil mb -l europe-west1 gs://date-media-utilizator-procesate
```

După ce ai finalizat acești pași, vei avea cele două bucket-uri create în Google Cloud Storage. Acestea vor fi utilizate pentru stocarea datelor media ale utilizatorilor.


### Pasul 2: Crearea Funcției Cloud și Configurarea Setărilor

1. Navighează la meniul din partea stângă și selectează "Cloud Functions".
2. Apasă pe butonul "+ Create function" pentru a începe procesul de creare a unei funcții Cloud noi.
3. În pagina de configurare a funcției Cloud, completează următoarele detalii:
- Name: Procesare-date-utilizator
- Mediu(Environment) functie: 2nd
- Region: europe-west1
- Trigger: Cloud Storage
- Bucket: date-media-utilizator-neprocesate
- Event Type: Finalize object (google.cloud.storage.object.v1.finalized)
4. În secțiunea "Runtime, build, connections and security settings", asigură-te că setezi "Runtime service account" pe "Service Account pentru Managementul Studentilor" (care a fost creat anterior). Aceasta este opțiunea care va permite funcției Cloud să acceseze resursele Google Cloud folosind service account-ul specificat.
5. După ce ai completat toate detaliile și setările necesare, apasă pe butonul "Next" pentru a continua.
6. În secțiunea "Source code", poți încărca codul funcției tale Cloud. 

In fisierul index.js
```javascript
const functions = require('@google-cloud/functions-framework');
const { Storage } = require('@google-cloud/storage');
const sharp = require('sharp');
const fs = require('fs');
const path = require('path');

const targetBucketName = 'date-media-utilizator-procesate-v2';

// Register a CloudEvent callback with the Functions Framework that will
// be triggered by Cloud Storage.
functions.cloudEvent('helloGCS', async (cloudEvent) => {
  console.log(`Event ID: ${cloudEvent.id}`);
  console.log(`Event Type: ${cloudEvent.type}`);

  const file = cloudEvent.data;
  console.log(`Bucket: ${file.bucket}`);
  console.log(`File: ${file.name}`);
  console.log(`Metageneration: ${file.metageneration}`);
  console.log(`Created: ${file.timeCreated}`);
  console.log(`Updated: ${file.updated}`);

  const storage = new Storage();
  const bucket = storage.bucket(file.bucket);
  const targetBucket = storage.bucket(targetBucketName);

  if (!fs.existsSync("/tmp/original")) {
    fs.mkdirSync("/tmp/original");
  }

  if (!fs.existsSync("/tmp/converted")) {
    fs.mkdirSync("/tmp/converted");
  }

  const originalFile = `/tmp/original/${file.name}`;
  const fileNameWithoutExtension = path.parse(file.name).name; // Remove file extension
  const destinationFile = `/tmp/converted/${fileNameWithoutExtension}-resized.jpg`; // Append "-resized" to the filename


  await bucket.file(file.name).download({
    destination: originalFile
  });

  // Resize the image to 100x100 using sharp
  await sharp(originalFile).resize(100, 100).toFile(destinationFile);

  await delay(2000);

  const convertedFile = await targetBucket.upload(destinationFile);

  console.log(`Converted file: ${convertedFile}`);
});

function delay(time) {
  return new Promise(resolve => setTimeout(resolve, time));
}

```

In fisierul package.json

```javascript
{
    "dependencies": {
      "@google-cloud/functions-framework": "^3.0.0",
      "@google-cloud/storage": "^5.18.2",
          "pdfkit": "^0.13.0",
          "pngjs": "^7.0.0",
          "sharp": "^0.33.3",
          "fs": "^0.0.1-security"
    }
  }
  ```

7. După ce ai încărcat codul și ai configurat eventualele setări suplimentare, apasă pe butonul "Deploy" pentru a crea funcția Cloud.

### Pasul 3: Testarea Funcției Cloud

1. Navighează la meniul din partea stângă și selectează "Storage" -> "Browser".
2. Identifică bucket-ul "date-media-utilizator-neprocesate-v2" și deschide-l.
3. Apasă pe butonul "Upload files" și selectează un fișier media local pe care dorești să-l încarci.
4. După ce fișierul este încărcat cu succes, așteaptă câteva momente pentru ca funcția să fie declanșată și să proceseze fișierul.
5. După ce procesul este complet, navighează la bucket-ul "date-media-utilizator-procesate-v2" în aceeași pagină "Storage".
6. Verifică dacă fișierul procesat, conform specificațiilor din funcția Cloud, este prezent în acest bucket.
7. Dacă fișierul procesat este prezent și este conform așteptărilor, funcția Cloud a fost testată cu succes.




### Pasul 4: Crearea unei baze de date folosind DataStore

Ruleaza comanda


```bash
gcloud firestore databases create \
--database=management-studenti \
--location=europe-west1 \
--type=firestore-native 
```
### Pasul 5: Deploy-ul unei Aplicații Node.js folosind Google App Engine

Rulează următoarea comandă pentru a crea o resursă de tip "datastore" cu numele "informatii-studenti":

```bash
gcloud datastore databases create informatii-studenti
```

1. Asigură-te că ești autentificat în Cloud Shell (dreapta sus) și că ești în directorul proiectului tău Node.js.

2. Ruleaza urmatoarele comenzi

```bash
git clone https://github.com/matei97/fii-cloud-computing-practice

cd fii-cloud-computing-practice/samples/google-cloud-sample/app-engine
```
3. Vizualizati fisierele

```bash
cat app.yaml
```
Acesta conține informații despre cum să fie configurată și rulată aplicația ta atunci când este desfășurată pe platforma Google App Engine. Iată o scurtă explicație a fiecărei secțiuni din fișierul app.yaml:

- runtime: Această secțiune specifică mediu de rulare pentru aplicația ta. În cazul tău, runtime: nodejs18 indică faptul că aplicația ta va rula pe mediul Node.js versiunea 18.
- service: Această secțiune specifică numele serviciului de App Engine. Acest nume este folosit pentru a identifica și gestiona serviciul tău în cadrul platformei Google Cloud.
- service_account: Aici specifici service account-ul care va fi folosit pentru a accesa resursele Google Cloud din cadrul aplicației tale. Acest service account este asociat cu rolurile și permisiunile necesare pentru a face operațiunile dorite în cloud.
- env_variables: Această secțiune permite definirea variabilelor de mediu care sunt disponibile în timpul rulării aplicației tale pe Google App Engine. În cazul tău, variabila GCLOUD_STORAGE_BUCKET este definită pentru a specifica bucket-ul Google Cloud Storage în care se vor încărca datele utilizatorului.


```bash
cat index.html
```

Acest fisier contine un formular pentru înregistrarea utilizatorilor și pentru încărcarea unei fotografii de profil. Iată o explicație detaliată a fiecărei secțiuni a fișierului:

```bash
cat app.js
```

Acesta este un fișier JavaScript care definește o aplicație Node.js care utilizează Google Cloud Storage pentru a încărca fișiere și Google Cloud Datastore pentru a salva datele utilizatorilor.

4. Rulează urmatoarea comanda pentru a încărca și a desfășura aplicația pe Google App Engine. Acest lucru va începe procesul de deploy și va crea o nouă versiune a aplicației tale.


```bash
gcloud app deploy
```
Numărul **11** corespunde locației europe-west.

5. Urmează instrucțiunile afișate în Cloud Shell pentru a confirma și a finaliza deploy-ul aplicației.

6. Pentru a afla URL-ul aplicației "default" de pe Google App Engine, poți folosi comanda gcloud app browse, astfel:

```bash
gcloud app browse
```